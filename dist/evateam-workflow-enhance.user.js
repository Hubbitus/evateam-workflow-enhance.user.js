// ==UserScript==
// @name         EvaTeam Workflow Enhancer
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  Replaces the built-in process view in EvaTeam with an advanced visualization using SvelteFlow
// @author       Pavel Alexeev <Pahan@Hubbitus.info>
// @match        https://eva.gid.team/project/Task/*
// @grant        none
// ==/UserScript==

!function(){"use strict";class e{constructor(e={}){this.config={baseUrl:"https://eva.gid.team/api/",mockUrls:{"CmfWorkflow.get":"./api/api_CmfWorkflow_get_response.json","CmfTrans.list":"./api/api_CmfTrans_list_response.json","CmfStatus.list":"./api/api_CmfStatus_list_response.json"},useMock:void 0!==e.useMock&&e.useMock,...e}}async call(e,t={}){try{let o;if(this.config.useMock&&this.config.mockUrls[e])o=this.config.mockUrls[e];else{o=`${this.config.baseUrl}?m=${e}`;const n=new URLSearchParams({m:e});for(const[e,o]of Object.entries(t))n.append(e,o);o=`${this.config.baseUrl}?${n.toString()}`}console.log(`HuEvaFlowEnhancer: Calling API method ${e} with URL: ${o}`);const n=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(!n.ok)throw new Error(`HTTP error! Status: ${n.status}`);const r=await n.json();return console.log(`HuEvaFlowEnhancer: API call ${e} successful`,r),r}catch(o){throw console.error(`HuEvaFlowEnhancer: Error calling API method ${e}:`,o),o}}async getWorkflow(e){const t={};e&&(t.id=e);return(await this.call("CmfWorkflow.get",t)).result}async getTransitions(e){const t={};e&&(t.workflow_id=e);return(await this.call("CmfTrans.list",t)).result}async getStatuses(e){const t={};e&&(t.workflow_id=e);return(await this.call("CmfStatus.list",t)).result}async getCompleteWorkflowData(e){try{console.log(`HuEvaFlowEnhancer: Getting complete workflow data for workflow ID: ${e}`);const[t,o,n]=await Promise.all([this.getWorkflow(e),this.getStatuses(e),this.getTransitions(e)]);return{workflow:t,statuses:o,transitions:n}}catch(t){throw console.error("HuEvaFlowEnhancer: Error getting complete workflow data:",t),t}}}class t{constructor(){this.api=new e({useMock:"undefined"!=typeof window&&window.location.hostname.includes("localhost")}),this.container=null,this.originalWorkflowElement=null,this.currentView="enhanced",this.workflowData=null,console.log("HuEvaFlowEnhancer: Initialized")}initialize(){console.log("HuEvaFlowEnhancer: Starting initialization"),this.waitForWorkflowElement().then(()=>{console.log("HuEvaFlowEnhancer: Workflow element found, proceeding with initialization"),this.setupContainer(),this.createTabsInterface(),this.loadAndDisplayWorkflow()}).catch(e=>{console.error("HuEvaFlowEnhancer: Error during initialization:",e)})}waitForWorkflowElement(){return new Promise((e,t)=>{if("undefined"!=typeof window&&window.storedWorkflowElement)return this.originalWorkflowElement=window.storedWorkflowElement,void e(this.originalWorkflowElement);const o=()=>{const t=document.querySelector(".cmf-dialog__content app-cmf-workflow-auto, #cdk-overlay-1 app-cmf-workflow-auto, .chart-container");t?(this.originalWorkflowElement=t,e(t)):setTimeout(o,500)},n=new MutationObserver(t=>{for(const o of t)if("childList"===o.type){const t=document.querySelector(".cmf-dialog__content app-cmf-workflow-auto, #cdk-overlay-1 app-cmf-workflow-auto, .chart-container");if(t)return this.originalWorkflowElement=t,n.disconnect(),void e(t)}});n.observe(document.body,{childList:!0,subtree:!0}),o(),setTimeout(()=>{n.disconnect(),t(new Error("Workflow element not found after timeout"))},1e4)})}setupContainer(){this.container=document.createElement("div"),this.container.id="hu-evateam-workflow-enhancer",this.container.style.width="100%",this.container.style.height="100%";const e=document.getElementById("workflow-container");e?e.appendChild(this.container):this.originalWorkflowElement.parentNode.insertBefore(this.container,this.originalWorkflowElement.nextSibling),console.log("HuEvaFlowEnhancer: Container set up")}createTabsInterface(){const e=document.createElement("div");e.className="workflow-tabs-container",e.style.display="flex",e.style.marginBottom="10px";const t=document.createElement("button");t.id="enhanced-workflow-tab",t.textContent="Улучшенная схема",t.style.flex="1",t.style.padding="10px",t.style.border="1px solid #ccc",t.style.borderRadius="4px 0 0 4px",t.style.cursor="pointer",t.style.backgroundColor="rgb(154 231 181)",t.style.fontWeight="bold",t.addEventListener("click",()=>this.switchView("enhanced"));const o=document.createElement("button");o.id="original-workflow-tab",o.textContent="Исходный workflow",o.style.flex="1",o.style.padding="10px",o.style.border="1px solid #ccc",o.style.borderLeft="none",o.style.borderRadius="0 4px 4px 0",o.style.cursor="pointer",o.style.backgroundColor="#f0f0f0",o.style.fontWeight="normal",o.addEventListener("click",()=>this.switchView("original")),e.appendChild(t),e.appendChild(o),this.container.appendChild(e);const n=document.createElement("div");n.id="original-workflow-view",n.style.display="none",n.style.width="100%",n.style.height="calc(100% - 50px)",n.style.overflow="auto";const r=n.attachShadow({mode:"open"}),l=document.createElement("style");if("undefined"!=typeof window&&window.storedWorkflowHTML){const e=(new DOMParser).parseFromString(window.storedWorkflowHTML,"text/html").querySelectorAll("style");for(const t of e)l.textContent+=t.textContent+"\n"}else{const e=document.querySelectorAll("style");for(const t of e)l.textContent+=t.textContent+"\n"}const i=document.querySelectorAll('link[rel="stylesheet"]');for(const c of i){const e=document.createElement("link");e.rel="stylesheet",e.href=c.href,r.appendChild(e)}r.appendChild(l);const s=this.originalWorkflowElement.cloneNode(!0);((e,t)=>{if(t.setAttribute("style",e.getAttribute("style")||""),t instanceof SVGElement){const o=e.getAttribute("class");o&&t.setAttribute("class",o)}else t.className=e.className||e.getAttribute("class")||"";const o=e.querySelectorAll("*"),n=t.querySelectorAll("*");for(let r=0;r<o.length;r++){const e=o[r],t=n[r];if(t){if(t.setAttribute("style",e.getAttribute("style")||""),t instanceof SVGElement){const o=e.getAttribute("class");o&&t.setAttribute("class",o)}else t.className=e.className||e.getAttribute("class")||"";for(let n of e.attributes)(n.name.startsWith("class")||n.name.startsWith("style")||n.name.startsWith("id")||n.name.startsWith("data-"))&&t.setAttribute(n.name,n.value);const o=window.getComputedStyle(e);if(o&&!t.hasAttribute("style")){const e=["color","background-color","border","border-radius","padding","margin","font-size","font-weight","text-align","display","position","width","height","top","left","right","bottom","transform","opacity","visibility","box-shadow","cursor","z-index","overflow"];let n="";for(const t of e){const e=o.getPropertyValue(t);e&&(n+=`${t}: ${e}; `)}n&&t.setAttribute("style",n)}}}})(this.originalWorkflowElement,s),r.appendChild(s);const a=document.createElement("div");a.id="enhanced-workflow-view",a.style.display="block",a.style.width="100%",a.style.height="calc(100% - 50px)",this.container.appendChild(n),this.container.appendChild(a),this.currentView="enhanced",console.log("HuEvaFlowEnhancer: Tabs interface created")}switchView(e){const t=document.getElementById("original-workflow-view"),o=document.getElementById("enhanced-workflow-view"),n=document.getElementById("original-workflow-tab"),r=document.getElementById("enhanced-workflow-tab");"original"===e?(t.style.display="block",o.style.display="none",n.style.backgroundColor="#e0e0e0",n.style.fontWeight="bold",r.style.backgroundColor="#f0f0f0",r.style.fontWeight="normal",this.currentView="original"):"enhanced"===e&&(t.style.display="none",o.style.display="block",o.hasChildNodes()||this.renderEnhancedWorkflow(o),n.style.backgroundColor="#f0f0f0",n.style.fontWeight="normal",r.style.backgroundColor="#e0e0e0",r.style.fontWeight="bold",this.currentView="enhanced"),console.log(`HuEvaFlowEnhancer: Switched to ${e} view`)}async loadAndDisplayWorkflow(){try{console.log("HuEvaFlowEnhancer: Loading workflow data...");const e=this.extractWorkflowId();if(!e)throw new Error("Could not extract workflow ID from the page");if(this.workflowData=await this.api.getCompleteWorkflowData(e),console.log("HuEvaFlowEnhancer: Workflow data loaded successfully",this.workflowData),"enhanced"===this.currentView){const e=document.getElementById("enhanced-workflow-view");this.renderEnhancedWorkflow(e)}}catch(e){console.error("HuEvaFlowEnhancer: Error loading workflow data:",e);const t=document.getElementById("enhanced-workflow-view");t&&(t.innerHTML=`\n                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: red;">\n                        <div>\n                            <h3>Error loading workflow</h3>\n                            <p>${e.message}</p>\n                            <p>Please check the console for more details.</p>\n                        </div>\n                    </div>\n                `)}}extractWorkflowId(){const e=[document.querySelector("[data-workflow-id]"),document.querySelector('[id*="workflow"]'),document.querySelector(".cmf-dialog__header .title"),document.querySelector("#cdk-overlay-1 .title")];for(const t of e)if(t){const e=t.getAttribute("data-workflow-id")||t.getAttribute("id")||t.getAttribute("data-id");if(e&&e.includes("CmfWorkflow"))return e;const o=(t.textContent||t.innerText).match(/CmfWorkflow:[a-f0-9-]+/i);if(o)return o[0]}if(this.originalWorkflowElement){let e=this.originalWorkflowElement.parentElement;for(;e&&e!==document.body;){const t=e.getAttribute("id");if(t&&t.includes("CmfWorkflow"))return t;const o=e.getAttribute("data-workflow-id");if(o)return o;e=e.parentElement}}return this.api.config.useMock?"CmfWorkflow:f3d3e174-cb06-11f0-9799-eeb7fce6ef9e":null}renderEnhancedWorkflow(e){if(void 0!==window.SvelteFlow){e.innerHTML="";try{const{nodes:t,edges:o}=this.prepareSvelteFlowData(),n=document.createElement("div");n.style.width="100%",n.style.height="100%",e.appendChild(n);new window.SvelteFlow({target:n,props:{nodes:t,edges:o,fitView:!0,defaultViewport:{x:0,y:0,zoom:1},onNodeDragStop:(e,t)=>{console.log("HuEvaFlowEnhancer: Node dragged",t)}}});console.log("HuEvaFlowEnhancer: Enhanced workflow rendered successfully with SvelteFlow")}catch(t){console.error("HuEvaFlowEnhancer: Error rendering enhanced workflow:",t),e.innerHTML=`\n                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: red;">\n                    <div>\n                        <h3>Error rendering enhanced workflow</h3>\n                        <p>${t.message}</p>\n                        <p>Please check the console for more details.</p>\n                    </div>\n                </div>\n            `}}else e.innerHTML='\n                <div style="display: flex; align-items: center; justify-content: center; height: 100%;">\n                    <div>\n                        <h3>SvelteFlow not loaded</h3>\n                        <p>Please ensure SvelteFlow is properly loaded via the bundled script.</p>\n                    </div>\n                </div>\n            '}prepareSvelteFlowData(){if(!this.workflowData)throw new Error("Workflow data not loaded");const{workflow:e,statuses:t,transitions:o}=this.workflowData,n=[],r=[];return t.forEach((t,o)=>{let r={x:100,y:100};if(e.scheme_draw_config){const o=`${t.id}_draw_scheme_item`,n=e.scheme_draw_config[o];n&&(r={x:n.x,y:n.y})}if(100===r.x&&100===r.y){const e=4;r={x:200+250*(o%e),y:150+200*Math.floor(o/e)}}const l=this.hexToRgbA(t.color,.15)||"#ffffff",i=this.adjustColorLightness(t.color,-20)||"#000000",s=this.adjustColorLightness(t.color,-80)||"#000000",a={id:t.id,type:"default",position:r,data:{label:t.name,description:t.text||"",color:t.color,statusType:t.status_type},style:{backgroundColor:l,borderColor:i,color:s,border:`2px solid ${i}`,borderRadius:"6px",padding:"10px",fontSize:"14px",fontWeight:"bold",minWidth:"120px",minHeight:"60px",display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},sourcePosition:"right",targetPosition:"left",draggable:!0};(t.name.toLowerCase().includes("старт")||"start"===t.code)&&(a.style.borderRadius="50%",a.style.minWidth="60px",a.style.minHeight="60px"),n.push(a)}),o.forEach(e=>{e.status_from.forEach(t=>{const o={id:`${t.id}-${e.status_to.id}`,source:t.id,target:e.status_to.id,type:"smoothstep",label:e.name.trim(),animated:!1,style:{stroke:"#456",strokeWidth:2},labelStyle:{fill:"#456",fontWeight:600,fontSize:"12px"},markerEnd:{type:"arrowclosed",color:"#456"}};r.push(o)})}),console.log("HuEvaFlowEnhancer: Prepared SvelteFlow data",{nodes:n,edges:r}),{nodes:n,edges:r}}hexToRgbA(e,t=1){if(!e)return null;e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(e,t,o,n)=>t+t+o+o+n+n);const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return o?`rgba(${parseInt(o[1],16)}, ${parseInt(o[2],16)}, ${parseInt(o[3],16)}, ${t})`:null}adjustColorLightness(e,t){if(!e)return null;e=e.replace(/^\s*#|\s*$/g,"");let o=parseInt(e.substr(0,2),16),n=parseInt(e.substr(2,2),16),r=parseInt(e.substr(4,2),16);return o=Math.min(255,Math.max(0,o+o*(t/100))),n=Math.min(255,Math.max(0,n+n*(t/100))),r=Math.min(255,Math.max(0,r+r*(t/100))),o=Math.round(o).toString(16).padStart(2,"0"),n=Math.round(n).toString(16).padStart(2,"0"),r=Math.round(r).toString(16).padStart(2,"0"),`#${o}${n}${r}`}}if("undefined"!=typeof window&&(window.HuEvaFlowEnhancer=t,window.HuEvaApi=e),"undefined"!=typeof window)if("loading"===document.readyState)document.addEventListener("DOMContentLoaded",()=>{const e=new t;window.enhancer=e,e.initialize()});else{const e=new t;window.enhancer=e,e.initialize()}}();
