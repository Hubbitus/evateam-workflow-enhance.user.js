# Заменяем встроенное представление процессов EvaTeam на продвинутое

В [EvaTeam](https://evateam.ru) на странице задач вроде https://eva.gid.team/project/Task/DATA-5945 есть кнопка отображения Workflow.
Там оно показывается в совершенно нечитаемом виде. Реализовываем решение в виде пользовательского скрипта (UserScript), добавляющее продвинутое представление, с цветами, перетягиванием, подсказками.

## Макеты и примеры

* В задаче Eva открывается схема процесса, которая выглядит примерно так: @makets/maket-workflow.as-is.png.
* HTML код данного блока (с минимальными стилями) представлен в файле @makets/maket.as-is.html.
* Примерный вид раскладки (функциональный макет, не стилевое оформление) представлен в файле @makets/maket.to-be.png

Необходимо написать `tampermonkey` `user.js` script в файле `evateam-workflow-enhance.user.js`, который преобразовывает это представление и модернизирует его!
**Но начинаем с дев-режима, формируем работающий прототип в файле makets/dev.html**.

Весь основной код (парсинг исходного HTML, построение схемы, события, логика) выносим в отдельный файл `HuEvaFlowEnhancer.js`. Он должен использоваться как в дев режиме, так и в итоговм юзерскрипте.

# Основные требования:
1. Все элементы должны быть перетаскиваемыми (`dragable`).
2. Для отображения схемы процесса используем [Svelte Flow](https://svelteflow.dev).
3. Все зависимости (`JS`, `CSS`) подключаем через `CDN`, проект не должен требовать отдельной сборки (кроме сборки юзерфайла, описанной далее) и сервера.
4. Для расположения блоков используем `Dagre layout vertical` как в примере https://svelteflow.dev/examples/layout/dagre.
   * По возможности блоки не должны пересекаться, выстраиваться сверху вниз, слева направ и  схема должна быть читаемой.
   * По возможности, не нарушая лайоута, предпочитаем расположение, помещающееся на одной странице экрана пользователя (на 90% доступного пространства), без прокрутки.
5. Цвета блоков необходимо взять из ответа `API`.
6. Именования и подписи стрелок и блоков берём из исходной диаграммы, через `API`.
   * Подробные описания, где есть, должны показываться во всплывающей подсказке, при наведении указателя мыши.
7. Исходное отображение, должно остаться и быть доступно на вкладке (`tab`) `Исходный workflow`
   * Должна быть возможность переключения пользователя между вкладками.
8. Если структура исходного `workflow` на странице окажется неожиданной или повреждённой, скрипт не должен "падать".
   * В этом случае следует отобразить сообщение об ошибке на месте новой диаграммы, с возможностью показать вкладку с исходным `workflow`.
   * В консоли вывести подробное сообщение об ошибке, что пошло не так.
   * Все соотщения в консоль, должны начинаться с префикса: `HuEvaFlowEnhancer: `

## Требования к `user.js` файлу

1. В Tampermonkey-скрипте зависимости подгружаем через директиву `@require` в заголовке, указывая ссылку на CDN.
2. Страницы на которых должен работать скрипт: `@match https://eva.gid.team/project/Task/*`
3. Автор скрипта: Pavel Alexeev <Pahan@Hubbitus.info>
4. Название: EvaTeam workflow enhancer.
5. Описание сгенерируй понятное, на 2-3 предложения. На английском.

## Дополнительное сохранение изменений пользователя (реализовываем позже, отдельно)

Если пользователь поменял расположение блоков, это должно сохраняться в локальном хранилище браузера (например localStorage) и восстанавливаться при последующем открытии этого же воркфлоу.
   * При этом стоит сохранять какой-то хеш воркфлоу, и если он изменится подтянуть изменения, даже если это где-то изменит положения
   * Постараться максимально сохранить то что было вручную упорядочено пользователем (не двигать блоки, которые не менялись).

# API
API примеры и описание приведены в @makets/api/README-API.md и там же требования к нему.

Требования по реализации:
1. Реализовываем класс `HuEvaApi.js`, дальше везде должен использоватья этот класс для получения данных и их манипуляции.
   * Он должен достаточно конфигурироваться чтобы использовался неизменяемым в проде (юзерскрипт) и на нашем моке, согласно мапингну урлов, описанному в @makets/api/README-API.md
2. Авторизацию подставлять не нужно, будет использоваться текущая кука пользователя.
3. Примеры приведены полные и избыточные, большинство заголовков нужно пропустить, кроме важных, таких как тип контента

# Dev режим
Для целей разработки будем делать `makets/dev.htm` файл, чтобы он моделировал загрузку и работу, без необходимости каждый раз инсталлировать `tampermonkey` скрипт.

JS подключаем в dev.html просто как <script src="http://localhost:3002/HuEvaFlowEnhancer.js">, а в tampermonkey скрипте `evateam-workflow-enhance.user.js` через `@require` по этому же адресу пока.

Добавь также "скрипт сборки" в виде Makefile чтобы этот класс заэмбеддить в итоговый, скажем аппендя в конец. Опиши его в `README.md`, как и весь процесс разработки и запуска.

## Dev запуск и отладка
1. В `dev.html` полностью должно быть проэмулировано как это будет работать в юзерскрипте, на предоставленных примерах API, соответствовать по логике и виду.
2. Вотчинг запущен (не надо запускать), можно смотреть и тестировать http://localhost:3000/
3. Для тестирования используй MCP и просмотр в браузере
   * Перед тем как рапортовать мне что-то смотреть, обязательно проверь что:
      - В консоли браузера нет ошибок. Если есть - необходимо сначала исправить!
      - В области построения `workflow` диаграммы имеется построение, соответствующее макету. Сделай скриншот в директорию `_screenshots`, файл по маске: `<date-time in ISO 8601 format with milliseconds>.png`

## Dev - принцип работы

В файле dev/index.html эмулируем работу реального скрипта UserScript:
1. Это значит, в первую очередь, что нам не нужно просто приложение, сколь-либо классное, но отдельное. Мы должны встроиться в уже имеющуюся страницу!
2. Так, проэмулировано появление нового блока <div id="cdk-overlay-1"> внутри блока <div class="cdk-global-overlay-wrapper">
3. Наше разрабатываемое решение HuEvaFlowEnhancer, должно с помощью MutationObserver дождаться этого!
   * При этом, используем именно MutationObserver, а не setInterval и поллинг! Мы не должны создавать лишней нагрузки, на странице этого блока может и не появиться!
4. При появлении этого блока, на его месте (вместо него), запустить наше Svelte приложение, которое:
   * Отрисует 2 вкладки: "Улучшенный workflow" и "Оригинальный workflow"
   * Во второй вкладке "Оригинальный workflow" должен быть представлен именно этот появившийся и заменяемый блок, "как есть"
   * А в первой "Улучшенный workflow", добавляем его улучшенную версию, с получением данных по API, и с отрисовкой на SvelteFlow!
      Этот флоу должен отображать логически то же самое, но красивее, элементы перетаскиваемые, стрелки плавные, расположение блоков автоматическое!
