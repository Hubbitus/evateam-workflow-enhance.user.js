# Анализ проекта EvaTeam Workflow Enhancer

## Обзор проекта

Проект представляет собой **UserScript для Tampermonkey**, предназначенный для улучшения визуализации workflow-диаграмм в системе управления проектами EvaTeam. Основная цель — заменить стандартное отображение бизнес-процессов на более современное и интерактивное решение с использованием ReactFlow.

### Назначение
- **Модернизация UI**: Преобразование статичных workflow-диаграмм в интерактивные
- **Улучшение UX**: Добавление возможности перетаскивания элементов
- **Персистентность**: Сохранение пользовательских настроек в localStorage
- **Совместимость**: Поддержка переключения между старой и новой версиями

## Технологический стек

### Основные технологии
- **JavaScript/ES6+**: Язык программирования
- **React 18**: Библиотека для создания пользовательского интерфейса
- **ReactFlow**: Библиотека для создания интерактивных диаграмм и графов
- **DOM API**: Для взаимодействия с существующим DOM EvaTeam
- **localStorage**: Для сохранения пользовательских настроек
- **MutationObserver**: Для отслеживания изменений в DOM

### Архитектурные решения
- **Tampermonkey UserScript**: Среда выполнения с поддержкой @require
- **CDN зависимости**: React и ReactFlow загружаются из unpkg.com
- **Модульная структура**: Разделение логики на функции
- **Реактивное программирование**: Использование React hooks для состояния

## Структура проекта

### Основные файлы
1. **evateam-workflow-enhance.user.js** - Основной UserScript файл
2. **README.md** - Документация проекта (пустой)
3. **makets/** - Директория с макетами и техническими материалами

### Директория makets/
- **maket.as-is.html** - HTML код исходной workflow-диаграммы EvaTeam
- **evateam-workflow-enhance.user.js.md** - Подробное техническое задание

## Анализ кода

### Архитектура скрипта

#### 1. Инициализация и загрузка зависимостей
```javascript
// Ожидание загрузки библиотек React и ReactFlow
function waitForLibraries(callback, retries = 50, delay = 200)
```

#### 2. Парсинг исходных данных
```javascript
// Извлечение узлов и связей из HTML EvaTeam
function parseOriginalWorkflow(htmlContent)
```

#### 3. React-компонент
```javascript
function WorkflowEnhancerApp() {
    // Управление состоянием узлов и связей
    // Переключение между вкладками
    // Интеграция с ReactFlow
}
```

#### 4. Инициализация приложения
```javascript
// Поиск целевого элемента DOM
// Рендеринг React-приложения
// Использование MutationObserver
```

### Ключевые особенности реализации

#### Парсинг workflow
- Извлекает узлы из HTML элементов с ID, начинающимися с `CmfStatus:`
- Определяет связи через overlay элементы с атрибутом `jtk-overlay-id`
- Сохраняет стили и позиционирование из исходного HTML

#### Управление состоянием
- Использует React hooks: `useNodesState`, `useEdgesState`
- Поддерживает интерактивное редактирование через ReactFlow
- Сохраняет изменения в localStorage (TODO)

#### Обработка ошибок
- Graceful degradation при отсутствии библиотек
- Валидация целевых DOM элементов
- Fallback на исходное отображение

## Команды разработки

### Сборка и установка
```bash
# Установка в Tampermonkey
# 1. Открыть Tampermonkey Dashboard
# 2. Создать новый скрипт
# 3. Скопировать содержимое evateam-workflow-enhance.user.js
# 4. Сохранить и активировать
```

### Тестирование
```bash
# Открыть страницу EvaTeam с workflow
# URL: https://eva.gid.team/project/Task/*
# Проверить наличие кнопки "Workflow"
# Убедиться в корректной работе переключения вкладок
```

### Отладка
```javascript
// Логирование в консоль браузера
console.log('Hu: EvaTeam Workflow Enhancer: ...');
// Проверка загрузки библиотек
// Мониторинг DOM изменений через MutationObserver
```

## Правила разработки

### Стиль кодирования
- **Комментарии**: Подробные логи с префиксом "Hu: EvaTeam Workflow Enhancer:"
- **Именование**: camelCase для переменных и функций
- **Структура**: Функциональный подход с модульной организацией

### Обработка ошибок
- Проверка наличия всех зависимых библиотек
- Валидация структуры DOM перед инициализацией
- Graceful degradation при ошибках парсинга

## Статус проекта

### Реализованные функции ✅
- [x] Парсинг исходной workflow-диаграммы
- [x] Интеграция с React и ReactFlow
- [x] Создание интерактивного UI
- [x] Переключение между вкладками
- [x] MutationObserver для отслеживания DOM

### Реализованные в v0.2 ✅
- [x] Автоматическое расположение узлов
- [x] Сохранение позиций в localStorage
- [x] Хеширование workflow для отслеживания изменений
- [x] Улучшенная обработка ошибок парсинга
- [x] Оптимизация производительности для больших диаграмм
- [x] Управление раскладкой (кнопки сброса и очистки)
- [x] Индикаторы состояния и загрузки
- [x] Graceful degradation и информативные сообщения об ошибках

## Использование

### Для пользователей
1. Установить Tampermonkey в браузер
2. Добавить скрипт из файла `evateam-workflow-enhance.user.js`
3. Открыть страницу задачи в EvaTeam
4. Нажать кнопку "Workflow"
5. Переключаться между вкладками "Улучшенный" и "Исходный" workflow

### Для разработчиков
1. Изучить структуру исходного HTML в `makets/maket.as-is.html`
2. Проанализировать логику парсинга в `parseOriginalWorkflow()`
3. Дополнить функциональность в `WorkflowEnhancerApp()`
4. Тестировать на реальных страницах EvaTeam

## Дальнейшее развитие

### Приоритетные задачи
1. **Персистентность данных**: Реализация сохранения позиций узлов
2. **Алгоритм авто-раскладки**: Улучшение читаемости диаграмм
3. **Валидация workflow**: Проверка целостности данных
4. **Производительность**: Оптимизация для больших диаграмм

---

**Дата анализа**: 3 февраля 2026 г.
**Версия**: 0.2
**Автор анализа**: KODA AI Assistant
